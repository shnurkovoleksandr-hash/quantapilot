---
id: "10_architecture"
title: "Architecture"
status: "ready"
version: "0.1.0"
updated: "2025-08-18"
owners: ["@owner"]
---

## System Context

QuantaPilot lives at the intersection of several systems:

* **Target repository (GitHub):** where all generated artefacts are created via pull requests. The factory never writes directly to its own repository【876102779380499†L2-L8】.
* **n8n orchestrator:** a self‑hosted workflow engine that coordinates agents, manages retries, timeouts and budgets.
* **Agents:** AI services specialised for architecture analysis, development and quality assurance. Each agent exposes a contract defined under `contracts/`.
* **PostgreSQL:** stores run history, metrics, token consumption and cost.
* **GitHub App & CLI:** provide minimal permissions to read/write repositories and to trigger runs.
* **Telegram Bot:** sends notifications and receives operator commands.

The overall system operates on a declarative configuration (the target project's `README.md` and `quantapilot.yml`) and produces deterministic artefacts. All side effects occur through version‑controlled pull requests【876102779380499†L37-L39】.

## Components

The factory is implemented as a PNPM monorepo with the following notable components:

* **n8n Flows:** YAML/JSON definitions of workflows executed by the n8n engine. A flow orchestrates cloning the repository, calling agents, validating outputs and opening PRs.
* **Agents:**
  * **PR/Architecture Agent** – analyses the target `README.md`, proposes architecture and generates the initial documentation suite (ANCHOR, overview, architecture, requirements, milestones, acceptance, constraints, runbook, ADRs, API and glossary).
  * **Development Agent** – executes tasks described in milestones, such as writing code and tests. It is idempotent and respects budgets.
  * **QA Agent** – runs static analysis and tests, verifies acceptance criteria and reports results.
* **CLI Package (`@quantapilot/cli`):** exposes a command‑line interface for operators to trigger runs and manage pipelines.
* **Core Package (`@quantapilot/core`):** contains type definitions and contracts shared between agents and the orchestrator.
* **Diagnostics Package (`@quantapilot/diagnostics`):** provides logging and replay utilities to reproduce runs.
* **Apps Directory (`apps/*`):** the workspace is prepared to host one or more end‑user applications. These are top‑level services generated by the factory (for example, a frontend or API server for the target project). The directory is currently empty but reserved for future application code.
* **Scripts Directory (`scripts`):** this directory is reserved for helper scripts used by the factory (e.g. database migrations, schema generation or n8n export helpers). It is empty in the initial skeleton but forms part of the workspace layout specified in `pnpm‑workspace.yaml`【660909509455998†L0-L3】.
* **Database Schema:** a minimal Postgres schema captures projects, tasks, runs and artefacts. See the database section of the additions guide for details.
* **Integration Services:** GitHub App for PRs and statuses, Telegram Bot for notifications.

## Data Flows

1. **Trigger:** The operator triggers a run via the CLI or an n8n webhook. They supply `repo_url` and `branch`.
2. **Clone:** n8n clones the target repository and reads its `README.md` and `quantapilot.yml`.
3. **Documentation generation:** The PR/Architecture Agent analyses the specification and generates the documentation set under `/docs` in the target repository. Front‑matter is validated against JSON schemas.
4. **Validation:** A doc‑lint step runs `ajv` against the generated files to ensure schemas are satisfied. If invalid, the run fails fast.
5. **Milestone planning:** The milestones document is parsed; for each milestone the system creates tasks that are handed to the Development Agent. Tasks include budgets and timeouts.
6. **Development:** The Development Agent generates code, tests and CI configuration. Artefacts are staged in a feature branch.
7. **QA:** The QA Agent executes unit, integration and negative tests. Results are recorded. If tests pass, the run proceeds; otherwise it retries based on the retry policy.
8. **Gate:** The system pauses at gates (e.g. acceptance of the anchor or milestone completion). The operator/reviewer approves or rejects. Decisions are recorded in ADRs.
9. **Merge:** Upon approval the branch is merged into the target branch. The system posts statuses and notifications.
10. **Monitoring:** Throughout the run, metrics (tokens, cost, duration) are collected and stored in PostgreSQL. Telegram notifications inform operators of state changes.

## Constraints

Architectural constraints include:

* **Single‑project isolation:** each run processes a single target project; pipelines never share state【876102779380499†L37-L40】.
* **Version locking:** tool versions (AI models, seeds, Node, PNPM, Python) are fixed for reproducibility【876102779380499†L37-L40】.
* **PR‑only policy:** all changes must go through pull requests; direct pushes are forbidden【876102779380499†L37-L39】.
* **Declarative configuration:** configuration must be supplied via files (`quantapilot.yml`), not through hidden settings【876102779380499†L37-L40】.

Further constraints around environment and compliance are described in [`60_constraints.md`](60_constraints.md).